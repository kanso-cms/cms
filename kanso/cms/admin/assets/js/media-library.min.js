!function(){var e=Modules.get("JSHelper"),t=Modules.require("Ajax"),i=window.location.href.replace(/admin(.+)/,"admin/media-library/"),s=["image/png","image/jpg","image/jpeg","image/gif"],a=function(){this.wrapper=e.$(".js-media-library"),this._instantiated=!1,this._isBulkSelect=!1,this._submitting=!1,this._currPage=0,this._isTriggerable=!1,this._maxImages=!1,this._noImages=!1,this._bulkSelects=[],this._currItem,this._listDZ,this._dedicatedDZ,this._imageTypes=["image/png","image/jpg","image/jpeg","image/gif"],this._showLibraryTrigger,this._bulkSlectTrigger=e.$(".js-bulk-select-trigger"),this._cancelBulkSlectTrigger=e.$(".js-cancel-bulk-select-trigger"),this._submitBulkDeleteTrigger=e.$(".js-bulk-delete-trigger"),this._globalProgress=e.$(".js-media-progress"),this._detailsForm=e.$(".js-media-details-form"),this._imgPreviewWrapper=e.$(".js-preivew-wrapper"),this._imagesContainer=e.$(".js-media-items"),this._fileURLText=e.$(".js-fileurl"),this._filePathText=e.$(".js-filepath"),this._fileNameText=e.$(".js-filename"),this._fileTypeText=e.$(".js-filetype"),this._fileDateText=e.$(".js-filedate"),this._fileSizeText=e.$(".js-filesize"),this._fileDimsText=e.$(".js-filedimensions"),this._fileUploaderText=e.$(".js-fileuploader"),this._fileTitleInput=e.$("#media_title"),this._fileAltInput=e.$("#media_alt"),this._fileURLInput=e.$("#media_url"),this._fileIdInput=e.$("#media_id"),this._sizeSelect=e.$("#media_size"),this._linkToSelect=e.$("#media_link_to_select"),this._linkToInput=e.$("#media_link_to_input"),this._linkToWrap=e.$(".js-link-to-wrap"),this._nextImgTrigger=e.$(".js-image-right-trigger"),this._prevImgTrigger=e.$(".js-image-left-trigger"),this._closeModalTrigger=e.$(".js-close-preview"),this._delMediaTrigger=e.$(".js-delete-media"),this._submitInsertTrigger=e.$(".js-insert-media"),this._submitUpdateTrigger=e.$(".js-update-media"),this._accessToken=e.$(".js-access-token"),e.nodeExists(this.wrapper)&&this.__construct()};a.prototype.__construct=function(){this._accessToken=this._accessToken.value,e.hasClass(this.wrapper.parentNode,"js-triggerable-media")?this._initTrigger():this._requestImages(),this._initImgClick(),this._initModal(),this._initBulkSelect(),this._initDropZones(),this._initScrollLoad(),this._initSelectListener()},a.prototype._initSelectListener=function(){var t=this;e.nodeExists(this._linkToSelect)&&e.addEventListener(this._linkToSelect,"change",function(i){i=i||window.event;var s=e.getInputValue(this);"custom"===s?t._linkToWrap.style.height="auto":t._linkToWrap.style.height="0"})},a.prototype._initTrigger=function(){this._isTriggerable=!0;for(var t=e.$All(".js-show-media-lib"),i=0;i<t.length;i++)e.addEventListener(t[i],"click",this._showLibrary);this._hideLibraryTrigger=e.$(".js-close-media-lib"),e.addEventListener(this._hideLibraryTrigger,"click",this._hideLibrary),e.addEventListener(this._submitInsertTrigger,"click",this._insertIntoPost)},a.prototype._showLibrary=function(){var t=Modules.get("MediaLibrary");e.addClass(t.wrapper.parentNode,"active"),e.addClass(document.body,"hide-overflow"),t._instantiated||t._requestImages()},a.prototype._initImgClick=function(){e.addEventListener(this._imagesContainer,"click",this._onImageClick)},a.prototype._onImageClick=function(t){var i=Modules.get("MediaLibrary");t=t||window.event;var s=t.target,a=!1;if(e.hasClass(s,"thumbnail")?a=s.parentNode.parentNode:e.hasClass(s,"media-item")&&(a=s),a)if(i._isBulkSelect)if(e.hasClass(a,"active")){e.removeClass(a,"active");for(var r=i._bulkSelects.length;r--;)i._bulkSelects[r]===a&&i._bulkSelects.splice(r,1)}else e.addClass(a,"active"),i._bulkSelects.push(a);else i._displayMediaDetails(a)},a.prototype._initBulkSelect=function(){var t=this;e.addEventListener(this._bulkSlectTrigger,"click",function(){t._enableBulkSelect()}),e.addEventListener(this._cancelBulkSlectTrigger,"click",function(){t._disableBulkSelect()}),e.addEventListener(this._submitBulkDeleteTrigger,"click",function(){t._submitBulkDelete()})},a.prototype._enableBulkSelect=function(){e.addClass(this.wrapper,"bulk-selecting"),this._isBulkSelect=!0,this._bulkSelects=[]},a.prototype._disableBulkSelect=function(){e.removeClass(this.wrapper,"bulk-selecting"),this._isBulkSelect=!1;for(var t=0,i=this._bulkSelects.length;i>t;t++){var s=this._bulkSelects[t];e.nodeExists(s)&&e.removeClass(s,"active")}this._bulkSelects=[]},a.prototype._submitBulkDelete=function(){if(this._submitting!==!0&&!e.empty(this._bulkSelects)){var s=this._bulkSelectIds(),a={ajax_request:"delete_media",access_token:this._accessToken,ids:s};this._submitting=!0;var r=this;t.post(i,a,function(t){var i=e.isJSON(t);if(i&&"valid"===i.response){for(var s=0,a=r._bulkSelects.length;a>s;s++)e.removeFromDOM(r._bulkSelects[s]);e.triggerEvent(r._cancelBulkSlectTrigger,"click"),r._checkIsEmpty()}r._submitting=!1},function(){r._submitting=!1,e.triggerEvent(r._cancelBulkSlectTrigger,"click")})}},a.prototype._bulkSelectIds=function(){for(var e=[],t=0,i=this._bulkSelects.length;i>t;t++)e.push(this._bulkSelects[t].dataset.id);return e},a.prototype._initModal=function(){var t=this;e.addEventListener(this._closeModalTrigger,"click",function(){t._hideMediaDetails()}),e.addEventListener(this._nextImgTrigger,"click",function(){t._nextImg()}),e.addEventListener(this._prevImgTrigger,"click",function(){t._prevImg()}),e.addEventListener(this._delMediaTrigger,"click",function(e){e=e||window.event,e.preventDefault(),t._confirmDelAttchment()}),e.addEventListener(this._submitUpdateTrigger,"click",function(e){e=e||window.event,e.preventDefault(),t._submitUpdateInfo()})},a.prototype._confirmDelAttchment=function(){var e=this,t=this._fileIdInput.value;Modules.require("Modal",{type:"danger",header:"danger",icon:"exclamation",title:"Please Confirm",message:"Are you POSITIVE you want to permanently delete this attachment?",closeText:"Cancel",closeClass:"btn-default",confirmClass:"btn-danger",confirmText:"Delete",overlay:"dark",extras:"",validateConfirm:function(){return e._submitDeleteFile(t)},closeAnywhere:!1})},a.prototype._submitUpdateInfo=function(){var s={ajax_request:"update_media_info",id:this._fileIdInput.value,title:this._fileTitleInput.value,alt:this._fileAltInput.value,access_token:this._accessToken},a=this;if(this._submitting===!0)return!1;this._submitting=!0,e.addClass(this._submitUpdateTrigger,"active");var r=e.$('[data-url="'+this._fileURLText.innerHTML.trim()+'"]',this.wrapper);return t.post(i,s,function(t){var i=e.isJSON(t);i&&"valid"===i.response&&(a._submitting=!1,e.removeClass(a._submitUpdateTrigger,"active"),Modules.require("Notifications",{type:"success",msg:"Media info successfully updated!"}),r.dataset.alt=s.alt,r.dataset.title=s.title)},function(){a._submitting=!1,e.removeClass(a._submitUpdateTrigger,"active"),Modules.require("Notifications",{type:"danger",msg:"There was an error processing your request."})}),!0},a.prototype._submitDeleteFile=function(s){var a={ajax_request:"delete_media",ids:[s],access_token:this._accessToken},r=this;return this._submitting===!0?!1:(this._submitting=!0,t.post(i,a,function(t){var i=e.isJSON(t);i&&"valid"===i.response&&(r._removeFile(s),r._submitting=!1)},function(){r._submitting=!1}),!0)},a.prototype._removeFile=function(t){var i=e.$('.media-item[data-id="'+t+'"]');e.nodeExists(i)&&e.removeFromDOM(i),this._hideMediaDetails(),this._checkIsEmpty()},a.prototype._displayMediaDetails=function(t){this._imgPreviewWrapper.innerHTML="";var i=new Image;i.src=t.dataset.preview,this._imgPreviewWrapper.appendChild(i),this._filePathText.innerHTML=t.dataset.path,this._fileURLText.innerHTML=t.dataset.url,this._fileNameText.innerHTML=t.dataset.name,this._fileTypeText.innerHTML=t.dataset.type,this._fileDateText.innerHTML=t.dataset.date,this._fileSizeText.innerHTML=t.dataset.size,this._fileDimsText.innerHTML=t.dataset.dimensions,this._fileUploaderText.innerHTML=t.dataset.user,this._fileTitleInput.value=t.dataset.title,this._fileAltInput.value=t.dataset.alt,this._linkToInput.value="",this._fileURLInput.value=t.dataset.url,this._fileIdInput.value=t.dataset.id,e.in_array(t.dataset.type,s)?e.addClass(e.$(".js-selected-media-container"),"is-image"):e.removeClass(e.$(".js-selected-media-container"),"is-image"),this._detailsForm.dataset.isimage=t.dataset.isimage,this._currItem=t,e.removeClass(this._nextImgTrigger,"disabled"),e.removeClass(this._prevImgTrigger,"disabled");for(var a=e.$All(".media-item",this.wrapper),r=0,n=a.length;n>r;r++)t===a[r]&&(0===r?e.addClass(this._prevImgTrigger,"disabled"):r===n-1&&e.addClass(this._nextImgTrigger,"disabled"));e.addClass(this.wrapper,"attachment-details")},a.prototype._hideMediaDetails=function(){e.removeClass(this.wrapper,"attachment-details"),this._currItem=null},a.prototype._nextImg=function(){if(this._submitting!==!0&&!e.hasClass(this._nextImgTrigger,"disabled"))for(var t=e.$All(".media-item",this.wrapper),i=0,s=t.length;s>i;i++)if(this._currItem===t[i]){this._displayMediaDetails(t[i+1]);break}},a.prototype._prevImg=function(){if(this._submitting!==!0&&!e.hasClass(this._prevImgTrigger,"disabled"))for(var t=e.$All(".media-item",this.wrapper),i=0,s=t.length;s>i;i++)if(this._currItem===t[i]){this._displayMediaDetails(t[i-1]);break}},a.prototype._requestImages=function(){if(this._maxImages!==!0){this._instantiated=!0;var s=this;e.addClass(s.wrapper,"loading"),t.post(i,this._imageForm(),function(t){var i=e.isJSON(t);return i&&i.response?void s._handleResponse(i.response):void s._setAsEmpty()},function(){s._setAsEmpty()})}},a.prototype._handleResponse=function(t){if(e.empty(t)){if(0===this._currPage)return void this._setAsEmpty();this._setMaxImages()}this._currPage+=1;for(var i=this,s=0,a=t.length;a>s;s++){var r=t[s],n=document.createElement("div"),l=new Image,o=s===t.length-1;n.className="media-item",n.dataset.id=r.id,n.dataset.url=r.url,n.dataset.preview=r.preview,n.dataset.path=r.path,n.dataset.date=r.date,n.dataset.alt=r.alt,n.dataset.title=r.title,n.dataset.size=r.size,n.dataset.user=r.user,n.dataset.type=r.type,n.dataset.name=r.name,n.dataset.dimensions=r.dimensions,n.dataset.isimage=e.in_array(r.type,this._imageTypes),l.setAttribute("alt",r.alt),l.setAttribute("title",r.title),l.src=r.preview;var d=document.createElement("div");d.className="center",d.appendChild(l);var p=document.createElement("div");p.className="thumbnail",p.appendChild(d);var c=document.createElement("div");c.className="preview",c.appendChild(p),c.innerHTML+='<div class="name">'+r.name+"</div>",n.appendChild(c),this._imagesContainer.appendChild(n),o&&(l.onload=function(t){t=t||window.event,e.removeClass(i.wrapper,"loading")})}},a.prototype._initDropZones=function(){var t={url:i,maxFilesize:10,parallelUploads:1,uploadMultiple:!1,clickable:!0,createImageThumbnails:!1,maxFiles:100,autoProcessQueue:!1,dictInvalidFileType:"Error! Unsupported file or files. You can't upload files of that type.",dictFileTooBig:"Error! File or files are too lare. Max upload size is 5mb per file.",dictResponseError:"There was an error processing the request. Try again in a few moments.",dictMaxFilesExceeded:"Error! Too many uploads at once. Upload limit is 1 file per drop."};this._listDZ=new Dropzone(e.$(".js-dz",this.wrapper),t),this._initDzEvents(this._listDZ)},a.prototype._initDzEvents=function(s){function a(){l.style.width="0%",e.removeClass(n._globalProgress,"active")}function r(t,i){var s=new Image;i.className="media-item",i.dataset.id=t.id,i.dataset.url=t.url,i.dataset.preview=t.preview,i.dataset.path=t.path,i.dataset.date=t.date,i.dataset.alt=t.alt,i.dataset.title=t.title,i.dataset.size=t.size,i.dataset.user=t.user,i.dataset.type=t.type,i.dataset.name=t.name,i.dataset.dimensions=t.dimensions,i.dataset.isimage=e.in_array(t.type,n._imageTypes),s.setAttribute("alt",t.alt),s.setAttribute("title",t.title),s.src=t.preview;var a=document.createElement("div");a.className="center",a.appendChild(s);var r=document.createElement("div");r.className="thumbnail",r.appendChild(a);var l=document.createElement("div");l.className="preview",l.appendChild(r),l.innerHTML+='<div class="name">'+t.name+"</div>",i.innerHTML="",i.appendChild(l),n._setAsNotEmpty()}var n=this,l=e.$(".progress",this._globalProgress);s.on("addedfile",function(s){var o=document.createElement("div");o.className="media-item uploading",o.innerHTML='<div class="preview"><svg viewBox="0 0 64 64" class="loading-spinner spinner-primary"><circle class="path" cx="32" cy="32" r="30" fill="none" stroke-width="4"></circle></svg><div class="name">'+s.name+"</div></div>";var d=n._imagesContainer;d.firstChild?d.insertBefore(o,d.firstChild):d.appendChild(o);var p={ajax_request:"file_upload",access_token:n._accessToken,file:s};t.upload(i,p,function(t){var i=e.isJSON(t);return i&&i.response&&e.is_array(i.response)&&e.isset(i.response[0])?(r(i.response[0],o),void a()):(n._submitting=!1,e.removeFromDOM(o),void a())},function(){n._submitting=!1,e.removeFromDOM(o),a()},function(){n._submitting=!0,e.addClass(n._globalProgress,"active")},function(e){e=e||window.event;e.loaded/e.total*100;l.style.width=e+"%"},function(){n._submitting=!1,a()})}),s.on("error",function(t){e.removeFromDOM(t.previewElement)})},a.prototype._initScrollLoad=function(){var t=this;if(this._isTriggerable){var i=this.wrapper.parentNode;e.addEventListener(i,"scroll",function(e){e|=window.event,i.offsetHeight+i.scrollTop>=i.scrollHeight&&(t._maxImages||t._noImages||t._submitting||t._requestImages())})}else e.addEventListener(window,"scroll",function(e){e|=window.event,window.innerHeight+window.scrollY>=document.body.scrollHeight&&(t._maxImages||t._noImages||t._submitting||t._requestImages())})},a.prototype._insertIntoPost=function(){var t=Modules.get("MediaLibrary"),i=t._fileURLInput.value,s=t._fileTitleInput.value,a=t._fileAltInput.value,r=e.getInputValue(t._sizeSelect),n=Modules.get("KansoWriter"),l=e.$("#media_url",t._detailsForm).value,o=e.getInputValue(t._linkToSelect),d=t.wrapper.dataset.blogLocation||!1;d="null"===d||"false"===d?!1:d;var p="",c="",m="";if(l=l.split("."),l=l[l.length-1],"false"!==t._detailsForm.dataset.isimage&&"origional"!==r){var u=i.split("."),l=u.pop(),h=u.join(".");i=h+"_"+r+"."+l}if("file"===o)p='<a href="'+i+'" title="'+s+'">',c="</a>";else if("attachment"===o){var _=window.location.origin+"/attachment/"+i.split("/").pop();d&&(_=window.location.origin+"/"+d+"/attachment/"+i.split("/").pop()),p='<a href="'+_+'" title="'+s+'" rel="attachment">',c="</a>"}else"custom"===o&&(p='<a href="'+t._linkToInput.value.trim()+'" title="'+s+'">',c="</a>");if("svg"===l)m='<img src="'+i+'" alt="'+a+'" title="'+s+'" width="" height="" />';else if("false"!==t._detailsForm.dataset.isimage)var m='<img src="'+i+'" alt="'+a+'" title="'+s+'" width="" height=""/>';n._insertText(p+m+c,n),t._hideLibrary(),t._hideMediaDetails()},a.prototype._checkIsEmpty=function(){var t=e.$(".media-item",this.wrapper);e.nodeExists(t)||this._setAsEmpty()},a.prototype._hideLibrary=function(){var t=Modules.get("MediaLibrary");t._hideMediaDetails(),e.removeClass(t.wrapper.parentNode,"active"),e.removeClass(t.wrapper,"feature-image"),e.removeClass(document.body,"hide-overflow")},a.prototype._setAsEmpty=function(){e.addClass(this.wrapper,"empty"),e.removeClass(this.wrapper,"loading"),this._maxImages=!0,this._noImages=!0},a.prototype._setAsNotEmpty=function(){e.removeClass(this.wrapper,"empty"),e.removeClass(this.wrapper,"loading"),this._noImages=!1},a.prototype._setMaxImages=function(){e.removeClass(this.wrapper,"loading"),this._maxImages=!0},a.prototype._imageForm=function(){return{ajax_request:"load_media",page:this._currPage,access_token:this._accessToken}},Modules.singleton("MediaLibrary",a).require("MediaLibrary")}();