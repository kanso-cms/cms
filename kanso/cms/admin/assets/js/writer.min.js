!function(){var l,t,o,i,e,n,p=Modules.get("JSHelper"),r=Modules.require("Ajax"),s=window.location.href.replace(/admin(.+)/,"admin/writer/"),a=p.$(".js-access-token").value,c=p.$(".js-writer-textarea"),d=p.$(".js-writer-footer .js-save-post"),u=p.$(".js-review-wrap .js-writer-form button[type=submit]"),h=p.$(".js-writer-wrap"),g=p.$(".js-reader-wrap"),v=p.$(".js-review-wrap"),f=[h,g,v],_=0,m=0,w=p.$(".js-writer-footer"),y=p.$(".js-writer-footer .js-raw"),b=p.$(".js-writer-footer .js-html"),j=p.$(".js-writer-footer .js-pre-publish"),S=[y,b,j],C=p.$(".js-sidebar"),$=p.$(".js-writer-context-menu");function k(e,t,i){[].forEach.call(e,function(e){void 0===i?e.classList.remove(t):e.classList[e==i?"add":"remove"](t)})}function L(){var e=window,t=document,i=t.documentElement,o=t.getElementsByTagName("body")[0];return e.innerHeight||i.clientHeight||o.clientHeight}function T(){this.version="2.0.0",this.author="Joe Howard",this.copyright="Kanso 2017",this._boot()}(T.prototype={}).api={code_editor:null,has_saved:!1,new_article:!0,article_id:null,is_published:!1,is_saving:!1,connected:!0},T.prototype._boot=function(){this._addBodyClasses(),this._getPostId(),this._bindSaveTrigger(),this._bindPublishTrigger(),this._bindSidebarTimer(),this._initCodeMirror(),this._startAutoSaver(),this._bindThumbnailChooser(),this._bindWindowResize(),this._bindInputChanges(),this._bindPostMetaTriggers(),this._bindFotterTriggers(),this._bindContextMenu(),this._initOfflineJs()},T.prototype._addBodyClasses=function(){document.getElementsByTagName("html")[0].className="writer-html",document.body.className="writing markdown"},T.prototype._getPostId=function(){var e=c.dataset.id;e&&""!==e&&(this.api.article_id=parseInt(e),this.api.new_article=!1)},T.prototype._bindSaveTrigger=function(){var t=this;p.addEventListener(d,"click",function(e){(e=e||window.event).preventDefault(),t._saveArticle(!0,!1)})},T.prototype._bindPublishTrigger=function(){var t=this;p.addEventListener(u,"click",function(e){(e=e||window.event).preventDefault(),t._saveArticle(!0,!0)})},T.prototype._bindSidebarTimer=function(){p.addEventListener(window,"mousemove",this._sidebarVisibilityHandler),p.addEventListener(window,"resize",this._hideSidebar)},T.prototype._sidebarVisibilityHandler=function(e){clearTimeout(i),e=e||window.event;var t=Modules.get("KansoWriter");event.clientX<70&&t._showSidebar(),i=setTimeout(function(){t._hideSidebar()},3e3)},T.prototype._hideSidebar=function(){clearTimeout(i),C.style.opacity="0"},T.prototype._showSidebar=function(){clearTimeout(i),C.style.opacity="1"},T.prototype._initCodeMirror=function(){var e=this._getInitialWriterContent();l=window.markdownit({html:!0,xhtmlOut:!1,breaks:!0,langPrefix:"",linkify:!1,highlight:this._highlightCode}),CodeMirrorSpellChecker({codeMirrorInstance:CodeMirror}),this.api.code_editor=CodeMirror(function(e){c.parentNode.replaceChild(e,c)},{value:e,mode:"spell-checker",backdrop:"markdown",lineWrapping:!0,lineNumbers:!1,dragDrop:!1,theme:"base16-light",scrollbarStyle:"overlay",extraKeys:{Enter:"newlineAndIndentContinueMarkdownList"}}),p.$(".CodeMirror"),this._bindCodeMirrorEvents()},T.prototype._getInitialWriterContent=function(){var e=c.innerHTML.trim();return e=(e=(e=p.ltrim(e,"\x3c!--[CDATA[")).replace(/\]\]\-\-\>$/,"")).trim()},T.prototype._highlightCode=function(t,e){if(""===e)return t;try{return hljs.highlight(e,t).value}catch(e){return t}},T.prototype._bindCodeMirrorEvents=function(){var e=this;this.api.code_editor.on("change",function(){e._onWriterChange()}),this.api.code_editor.on("keyup",function(){13==event.keyCode&&e._checkForLists()})},T.prototype._onWriterChange=function(){this._windowResizeHandler(),this._hideSidebar(),this._hideFooter(),this._startAutoSaver()},T.prototype._bindFotterTriggers=function(){var e=this;p.addEventListener(window,"mousemove",this._footerVisibilityHandler),this._bindViewTriggers(),p.addEventListener(p.$(".js-writer-footer .js-insert-h1"),"click",function(){e._toggleHeading("#")}),p.addEventListener(p.$(".js-writer-footer .js-insert-h2"),"click",function(){e._toggleHeading("##")}),p.addEventListener(p.$(".js-writer-footer .js-insert-h3"),"click",function(){e._toggleHeading("###")}),p.addEventListener(p.$(".js-writer-footer .js-insert-h4"),"click",function(){e._toggleHeading("####")}),p.addEventListener(p.$(".js-writer-footer .js-insert-h5"),"click",function(){e._toggleHeading("#####")}),p.addEventListener(p.$(".js-writer-footer .js-insert-h6"),"click",function(){e._toggleHeading("######")}),p.addEventListener(p.$(".js-writer-footer .js-insert-list-normal"),"click",function(){e._toggleList(!0)}),p.addEventListener(p.$(".js-writer-footer .js-insert-list-numbered"),"click",function(){e._toggleList(!1)}),p.addEventListener(p.$(".js-writer-footer .js-insert-table"),"click",function(){e._insertText(e._tableTemplate())}),p.addEventListener(p.$(".js-writer-footer .js-insert-bold"),"click",function(){e._toggleTextStyle("**")}),p.addEventListener(p.$(".js-writer-footer .js-insert-italic"),"click",function(){e._toggleTextStyle("_")}),p.addEventListener(p.$(".js-writer-footer .js-insert-strike"),"click",function(){e._toggleTextStyle("~~")}),p.addEventListener(p.$(".js-writer-footer .js-insert-link"),"click",function(){e._insertWrapText("[","](href)","[text](href)")}),p.addEventListener(window,"resize",this._hideFooter)},T.prototype._bindViewTriggers=function(){for(var e=0;e<S.length;e++)p.addEventListener(S[e],"click",this._changeViewHandler)},T.prototype._changeViewHandler=function(e){e=e||window.event;var t,i=Modules.get("KansoWriter"),o=p.closest(e.target,"button");if(!p.hasClass(o,"active")){var n=!1,r=!1,s=document.title.split("|").pop().trim(),a="Review";if(i._saveCurrScrollPos(),o===y?(scrollToWrite=!0,t=h,a="Write",document.getElementsByTagName("html")[0].className="writer-html",i._windowResizeHandler()):o===b?(n=!0,(t=g).innerHTML=l.render(i.api.code_editor.getValue()),a="Read",document.getElementsByTagName("html")[0].className="reading-html"):(r=!0,t=v,document.getElementsByTagName("html")[0].className="review-html"),null!==i.api.article_id){var c=p.$(".js-writer-form input[name=title]").value.trim();s=""===c?"Untitled":c}k(f,"active",t),k(S,"active",o),n&&window.scrollTo(0,_),r&&window.scrollTo(0,m),document.title=a+" | "+s}},T.prototype._saveCurrScrollPos=function(){var e=p.$(".js-writer-footer .view-toggles button.active"),t=document.documentElement;e===b&&(_=(window.pageYOffset||t.scrollTop)-(t.clientTop||0)),e===j&&(m=(window.pageYOffset||t.scrollTop)-(t.clientTop||0)),e===y&&this.api.code_editor.getScrollInfo().top},T.prototype._footerVisibilityHandler=function(e){e=e||window.event;var t=window.innerHeight-event.clientY,i=Modules.get("KansoWriter");clearTimeout(o),t<40&&i._showFooter(),o=setTimeout(function(){i._hideFooter()},3e3)},T.prototype._showFooter=function(){clearTimeout(o),p.addClass(w,"active")},T.prototype._hideFooter=function(){clearTimeout(o),p.removeClass(w,"active")},T.prototype._toggleHeading=function(e){var t=this.api.code_editor.getCursor().line,i=this.api.code_editor.getLine(t),o=i.length;if(""!==i&&i[0]&&"#"===i[0]){var n=new RegExp("^"+e+"\\s.+$"),r=new RegExp("^"+e+"$"),s=new RegExp("^"+e+"\\s+$");i=n.test(i)||r.test(i)||s.test(i)?p.ltrim(p.ltrim(i,["#","##","###","####","#####","#####"])):e+" "+p.ltrim(p.ltrim(i,["#","##","###","####","#####","#####"]))}else i=e+" "+p.ltrim(i);this.api.code_editor.replaceRange(i,{line:t,ch:0},{line:t,ch:o}),this._showFooter(),this.api.code_editor.focus()},T.prototype._toggleList=function(e){var t=this.api.code_editor.getCursor().line,i=this.api.code_editor.getLine(t),o=i.length,n="";if(e)n=""===i||!i[0]||"-"!==i[0]&&"+"!==i[0]&&"*"!==i[0]||!i[1]||""!==i[1]&&" "!==i[1]?"- "+p.ltrim(i):p.ltrim(p.ltrim(i,["-","+","*"]));else{var r=new RegExp("^\\d+.\\s+");if(r.test(i))n=p.ltrim(i.replace(/\d+\.\s+/,""));else{var s=1;if(0<t){var a=this.api.code_editor.getLine(t-1);r.test(a)&&(s=parseInt(a[0])+1)}n=s+". "+p.ltrim(i)}}this.api.code_editor.replaceRange(n,{line:t,ch:0},{line:t,ch:o}),this._showFooter(),this.api.code_editor.focus()},T.prototype._toggleTextStyle=function(e){var t=this.api.code_editor.somethingSelected()?this.api.code_editor.getCursor("to"):this.api.code_editor.getCursor(),i=this.api.code_editor.getLine(t.line),o=i.length,n=new RegExp(p.preg_quote(e)+"(.*?)"+p.preg_quote(e)),r=p.preg_match_all(n,i),s="";if(r){for(var a=[],c=0;c<r.length;c++)a.push(r[c].index);var l=function(e,t){for(var i=e[0],o=0;o<e.length;o++){var n=e[o];Math.abs(t-n)<Math.abs(t-i)&&(i=n)}return i}(a,t.ch),d=p.str_split_index(i,l);s=d[0]+p.str_replace(e,"",d[1],2)}else{if(this.api.code_editor.somethingSelected())return s=e+this.api.code_editor.getSelection()+e,this.api.code_editor.replaceSelection(s,"start"),this._showFooter(),void this.api.code_editor.focus();s=e+i+e}this.api.code_editor.replaceRange(s,{line:t.line,ch:0},{line:t.line,ch:o}),this._showFooter(),this.api.code_editor.focus()},T.prototype._insertWrapText=function(e,t,i){var o="";o=this.api.code_editor.somethingSelected()?e+this.api.code_editor.getSelection()+t:i,this.api.code_editor.replaceSelection(o,"start"),this._showFooter(),this.api.code_editor.focus()},T.prototype._insertText=function(e){var t=this.api.code_editor,i=t.getCursor(),o=t.getLine(i.line),n={line:i.line,ch:o.length};t.replaceRange(e,n),this._showFooter(),t.focus()},T.prototype._bindPostMetaTriggers=function(){for(var e=p.$(".js-add-post-meta-btn"),t=p.$All(".js-rmv-post-meta-btn"),i=0;i<t.length;i++)p.addEventListener(t[i],"click",this._removePostMetaHandler);p.addEventListener(e,"click",this._addPostMetaHandler)},T.prototype._removePostMetaHandler=function(e){(e=e||window.event).preventDefault(),p.removeFromDOM(p.parentUntillClass(this,"js-meta-row"))},T.prototype._addPostMetaHandler=function(e){(e=e||window.event).preventDefault();var t=p.$(".js-post-meta-container"),i=Modules.get("KansoWriter"),o=document.createElement("DIV");o.className="row roof-xs js-meta-row",o.innerHTML=['<div class="form-field floor-xs">',"<label>Key</label>",'<input type="text" name="post-meta-keys[]" value="" autocomplete="off" size="20">',"</div>","&nbsp;&nbsp;&nbsp;",'<div class="form-field floor-xs">',"<label>Value</label>",'<input type="text" name="post-meta-values[]" value="" autocomplete="off" size="60">',"</div>","&nbsp;&nbsp;&nbsp;",'<button class="btn btn-danger js-rmv-post-meta-btn" type="button">Remove</button>','<div class="row clearfix"></div>'].join(""),t.appendChild(o),p.addEventListener(p.$(".js-rmv-post-meta-btn",o),"click",i._removePostMetaHandler)},T.prototype._bindWindowResize=function(){var e=this;e.api.code_editor.on("viewportChange",e._windowResizeHandler),p.addEventListener(window,"resize",e._windowResizeHandler),e._windowResizeHandler(),e.api.code_editor.execCommand("goDocStart"),e.api.code_editor.focus(),e.api.code_editor.refresh()},T.prototype._windowResizeHandler=function(){h.style.height=window.innerHeight+"px"},T.prototype._bindThumbnailChooser=function(){var t=this,e=p.$(".js-select-img-trigger"),i=p.$(".js-remove-img-trigger"),o=p.$(".js-set-feature-image");p.addEventListener(e,"click",function(e){(e=e||window.event).preventDefault(),t._showMediaLibrary()}),p.addEventListener(o,"click",function(e){(e=e||window.event).preventDefault(),t._setThumbnailImage()}),p.addEventListener(i,"click",function(e){(e=e||window.event).preventDefault(),t._clearThumbnailImage()})},T.prototype._showMediaLibrary=function(e){p.addClass(p.$(".js-media-library"),"feature-image")},T.prototype._setThumbnailImage=function(){Modules.get("MediaLibrary")._hideLibrary(),p.$(".js-feature-id").value=p.$("#media_id").value,p.$(".js-feature-img img").src=p.$("#media_url").value,p.addClass(p.$(".js-feature-img"),"active")},T.prototype._clearThumbnailImage=function(){p.$(".js-feature-id").value="",p.removeClass(p.$(".js-feature-img"),"active"),p.$(".js-feature-img img").src=""},T.prototype._bindInputChanges=function(){for(var e=p.$All(".js-review-wrap input, .js-review-wrap textarea, .js-review-wrap select"),t=0;t<e.length;t++)p.addEventListener(e[t],"input",this._inputChangeHandler)},T.prototype._inputChangeHandler=function(e){Modules.get("KansoWriter")._startAutoSaver()},T.prototype._saveArticle=function(i,o){i=void 0!==i&&i,o=void 0!==o&&o;var n=this;if(this._clearAutoSave(),!0!==this.api.is_saving&&!1!==this.api.connected){this.api.is_saving=!0,o?p.addClass(u,"active"):p.addClass(d,"active");var e=Modules.get("FormValidator",p.$(".js-writer-form"));e.append("ajax_request",this._getAjaxType()),e.append("id",this.api.article_id),e.append("content",this.api.code_editor.getValue()),e.append("access_token",a),o?(this.api.is_published=!0,e.append("status","published")):!0===this.api.is_published?e.append("status","published"):"writer_save_new_article"===this._getAjaxType()&&e.append("status","draft");var t=e.form();t.hasOwnProperty("post-meta-values[]")&&(t["post-meta-values"]=JSON.stringify(t["post-meta-values[]"]),delete t["post-meta-values[]"]),t.hasOwnProperty("post-meta-keys[]")&&(t["post-meta-keys"]=JSON.stringify(t["post-meta-keys[]"]),delete t["post-meta-keys[]"]),r.post(s,t,function(e){var t=p.isJSON(e);t&&t.response?n._onSaved(t.response.id,t.response.slug,i,o):Modules.require("Notifications",{type:"danger",msg:"The server encountered an error while saving the article."}),n.api.is_saving=!1,n._startAutoSaver()},function(e){Modules.require("Notifications",{type:"danger",msg:"The server encountered an error while saving the article."}),n.api.is_saving=!1,n._startAutoSaver()})}},T.prototype._getAjaxType=function(){return!0===this.api.new_article?"writer_save_new_article":"writer_save_existing_article"},T.prototype._onSaved=function(e,t,i,o){if(i&&o){var n=location.protocol+"//"+location.host+"/"+t;Modules.require("Notifications",{type:"success",msg:'Your article was successfully published. Click <a href="'+n+'" target="_blank">here</a> to view live.'}),this.api.is_published=!0}else if(i){n=location.protocol+"//"+location.host+"/"+t;Modules.require("Notifications",{type:"success",msg:'Your article was successfully saved. Click <a href="'+n+'" target="_blank">here</a> to view live.'})}p.removeClass(d,"active"),p.removeClass(u,"active"),this.api.article_id=parseInt(e),this.api.new_article=!1},T.prototype._checkForLists=function(){var e=this.api.code_editor.getCursor().line-1,t=this.api.code_editor.getLine(e),i=new RegExp("^\\d+.\\s+"),o=1+e;""!==t&&(""===t||!t[0]||"-"!==t[0]&&"+"!==t[0]&&"*"!==t[0]||!t[1]||""!==t[1]&&" "!==t[1]?i.test(t)&&(num=parseInt(t[0])+1,toInsert=num+". ",this.api.code_editor.replaceRange(toInsert,{line:o,ch:0})):(toInsert=t[0]+" ",this.api.code_editor.replaceRange(toInsert,{line:o,ch:0})))},T.prototype._startAutoSaver=function(){var t=this;this._clearAutoSave(),e=setTimeout(function(){var e=t.api.code_editor.getValue().trim();""!==e&&n!==e&&(n=e,t._saveArticle(!1))},5e3)},T.prototype._clearAutoSave=function(){clearTimeout(e)},T.prototype._tableTemplate=function(){return["\n| Tables        | Are           | Cool  |\n","| ------------- |:-------------:| -----:|\n","| col 3 is      | right-aligned | $1600 |\n","| col 2 is      | centered      |   $12 |\n","| zebra stripes | are neat      |    $1 |\n"].join("")},T.prototype._bindContextMenu=function(){var i=this.api.code_editor,e=CodeMirror.commands;p.addEventListener(p.$(".js-g-search"),"click",function(){i.somethingSelected()&&window.open("https://www.google.com.au/search?q="+encodeURIComponent(i.getSelection().trim()),"_blank").focus()}),p.addEventListener(p.$(".js-open-dictionary"),"click",function(){i.somethingSelected()&&window.open("https://www.google.com.au/search?q=define:"+encodeURIComponent(i.getSelection().trim()),"_blank").focus()}),p.addEventListener(p.$(".js-open-thesaurus"),"click",function(){i.somethingSelected()&&window.open("https://en.oxforddictionaries.com/thesaurus/"+encodeURIComponent(i.getSelection().trim()),"_blank").focus()}),p.addEventListener(p.$(".js-open-wiki"),"click",function(){i.somethingSelected()&&window.open("https://en.wikipedia.org/wiki/"+encodeURIComponent(i.getSelection().trim()),"_blank").focus()}),p.addEventListener(p.$(".js-cut"),"click",function(){if(i.somethingSelected()){var e=i.getSelection().trim();clipboard.writeText(e),t=e,i.replaceSelection("","start"),i.focus()}}),p.addEventListener(p.$(".js-copy"),"click",function(){i.somethingSelected()&&(t=i.getSelection().trim(),clipboard.writeText(t))}),p.addEventListener(p.$(".js-paste"),"click",function(){clipboard.readText().then(function(e){i.somethingSelected()||(pos=i.getCursor(),i.setSelection(pos,pos)),i.replaceSelection(e,"start"),i.focus()},function(){t&&(i.somethingSelected()||(pos=i.getCursor(),i.setSelection(pos,pos)),i.replaceSelection(t,"start")),i.focus()})}),p.addEventListener(p.$(".js-select-all"),"click",function(){e.selectAll(i)}),p.addEventListener(p.$(".js-select-word"),"click",function(){e.selectNextOccurrence(i)}),p.addEventListener(p.$(".js-titlecase-trigger"),"click",function(){if(i.somethingSelected()){i.getSelection();i.replaceSelection(function(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}(i.getSelection()),"start"),i.focus()}}),p.addEventListener(p.$(".js-uppercase-trigger"),"click",function(){i.somethingSelected()&&(i.replaceSelection(i.getSelection().toUpperCase(),"start"),i.focus())}),p.addEventListener(p.$(".js-lowercase-trigger"),"click",function(){i.somethingSelected()&&(i.replaceSelection(i.getSelection().toLowerCase(),"start"),i.focus())}),p.addEventListener(p.$(".js-sentence-trigger"),"click",function(){i.somethingSelected()&&(i.replaceSelection(function(e){var t="";if(0==(e="."+e).length)return t;for(var i=!1,o=[".","?","!"],n=0;n<e.length;n++){var r=e.charAt(n);if(i)if(" "==r)t+=r;else{t+=r.toUpperCase(),i=!1}else t+=r.toLowerCase();for(var s=0;s<o.length;s++)if(r==o[s]){i=!0;break}}return t.substring(1,t.length-1)}(i.getSelection()),"start"),i.focus())}),p.addEventListener(p.$(".js-suggestions div"),"click",function(e){var t=e.target;p.hasClass(t,"js-suggestion")&&(i.replaceSelection(t.innerHTML.trim(),"start"),i.focus())}),p.addEventListener(h,"contextmenu",this._handleContextMenuVisibility),$Spelling.DefaultDictionary="English (UK)"},T.prototype._handleContextMenuVisibility=function(e){(e=e||window.event).preventDefault();var t=Modules.get("KansoWriter");t._styleContextMenu(e),p.addClass($,"active"),p.addClass(document.body,"context-menu-active"),window.addEventListener("click",t._hideContextMenu),t.api.code_editor.somethingSelected()&&t._contextMenuSuggestions()},T.prototype._styleContextMenu=function(e){this.api.code_editor.somethingSelected()?p.addClass($,"something-selected"):p.removeClass($,"something-selected"),L()-e.clientY<377?$.style.top=e.clientY-377+"px":$.style.top=e.clientY+"px",L()-e.clientY<440?(p.$(".js-suggestions > div").style.top="initial",p.$(".js-suggestions > div").style.bottom="0",p.$(".js-context-menu-casings > div").style.top="initial",p.$(".js-context-menu-casings > div").style.bottom="0"):(p.$(".js-suggestions > div").style.top="0",p.$(".js-suggestions > div").style.bottom="initial",p.$(".js-context-menu-casings > div").style.top="0",p.$(".js-context-menu-casings > div").style.bottom="initial"),$.style.left=e.clientX+"px"},T.prototype._hideContextMenu=function(e){p.removeClass($,"active"),p.removeClass(document.body,"context-menu-active"),window.removeEventListener("click",Modules.get("KansoWriter")._hideContextMenu)},T.prototype._contextMenuSuggestions=function(){var e=p.$(".js-suggestions ul"),t=this.api.code_editor.getSelection().trim();if(e.innerHTML="",1<p.count(t.split(" ")))e.innerHTML='<li style="opacity:0.3">No Suggestions</li>';else if(""!==t){var i=$Spelling.SpellCheckSuggest(t);if(p.empty(i))return void(e.innerHTML='<li style="opacity:0.3">No Suggestions</li>');p.isset(i[1])||(i=i[0]);for(var o=0;o<i.length;o++)e.innerHTML+='<li class="js-suggestion">'+i[o]+"</li>"}},T.prototype._initOfflineJs=function(){var e=this,t=p.$(".js-offline-overlay");function i(){p.removeClass(t,"active"),Offline.off("up",i),e.api.connected=!0,e._startAutoSaver()}Offline.options={checkOnLoad:!1,interceptRequests:!1,checks:{xhr:{url:window.location.href.replace(/admin(.+)/,"kanso/cms/admin/assets/js/check-connection.js")}},requests:!1,game:!1},Offline.on("down",function(){p.addClass(t,"active"),Offline.on("up",i),e.api.connected=!1,e._clearAutoSave()})},Modules.singleton("KansoWriter",T).get("KansoWriter")}();