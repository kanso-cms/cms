!function(){function e(e,t){for(var i=e[0],o=0;o<e.length;o++){var n=e[o];Math.abs(t-n)<Math.abs(t-i)&&(i=n)}return i}function t(e,t,i){[].forEach.call(e,function(e){"undefined"==typeof i?e.classList.remove(t):e.classList[e==i?"add":"remove"](t)})}function i(e){e="."+e;var t="";if(0==e.length)return t;for(var i=!1,o=[".","?","!"],n=0;n<e.length;n++){var r=e.charAt(n);if(i)if(" "==r)t+=r;else{var s=r.toUpperCase();t+=s,i=!1}else{var a=r.toLowerCase();t+=a}for(var c=0;c<o.length;c++)if(r==o[c]){i=!0;break}}return t=t.substring(1,t.length-1)}function o(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function n(){var e=window,t=document,i=t.documentElement,o=t.getElementsByTagName("body")[0];return e.innerHeight||i.clientHeight||o.clientHeight}var r,s,a,c,l,d,p,u=Modules.get("JSHelper"),h=Modules.require("Ajax"),g=window.location.href.replace(/admin(.+)/,"admin/writer/"),f=u.$(".js-access-token").value,v=u.$(".js-writer-textarea"),_=u.$(".js-writer-footer .js-save-post"),m=u.$(".js-review-wrap .js-writer-form button[type=submit]"),w=u.$(".js-writer-wrap"),y=u.$(".js-reader-wrap"),b=u.$(".js-review-wrap"),j=[w,y,b],S=0,C=0,$=0,L=u.$(".js-writer-footer"),k=u.$(".js-writer-footer .js-raw"),T=u.$(".js-writer-footer .js-html"),x=u.$(".js-writer-footer .js-pre-publish"),E=[k,T,x],M=u.$(".js-sidebar"),H=u.$(".js-writer-context-menu"),A=function(){this.version="2.0.0",this.author="Joe Howard",this.copyright="Kanso 2017",this._boot()};A.prototype={},A.prototype.api={code_editor:null,has_saved:!1,new_article:!0,article_id:null,is_published:!1,is_saving:!1,connected:!0},A.prototype._boot=function(){this._addBodyClasses(),this._getPostId(),this._bindSaveTrigger(),this._bindPublishTrigger(),this._bindSidebarTimer(),this._initCodeMirror(),this._startAutoSaver(),this._bindThumbnailChooser(),this._bindWindowResize(),this._bindInputChanges(),this._bindPostMetaTriggers(),this._bindFotterTriggers(),this._bindContextMenu(),this._initOfflineJs()},A.prototype._addBodyClasses=function(){document.getElementsByTagName("html")[0].className="writer-html",document.body.className="writing markdown"},A.prototype._getPostId=function(){var e=v.dataset.id;e&&""!==e&&(this.api.article_id=parseInt(e),this.api.new_article=!1)},A.prototype._bindSaveTrigger=function(){var e=this;u.addEventListener(_,"click",function(t){t=t||window.event,t.preventDefault(),e._saveArticle(!0,!1)})},A.prototype._bindPublishTrigger=function(){var e=this;u.addEventListener(m,"click",function(t){t=t||window.event,t.preventDefault(),e._saveArticle(!0,!0)})},A.prototype._bindSidebarTimer=function(){u.addEventListener(window,"mousemove",this._sidebarVisibilityHandler),u.addEventListener(window,"resize",this._hideSidebar)},A.prototype._sidebarVisibilityHandler=function(e){clearTimeout(l),e=e||window.event;var t=Modules.get("KansoWriter"),i=event.clientX;70>i&&t._showSidebar(),l=setTimeout(function(){t._hideSidebar()},3e3)},A.prototype._hideSidebar=function(){clearTimeout(l),M.style.opacity="0"},A.prototype._showSidebar=function(){clearTimeout(l),M.style.opacity="1"},A.prototype._initCodeMirror=function(){var e=this,t=this._getInitialWriterContent();r=window.markdownit({html:!0,xhtmlOut:!1,breaks:!0,langPrefix:"",linkify:!1,highlight:e._highlightCode}),CodeMirrorSpellChecker({codeMirrorInstance:CodeMirror}),this.api.code_editor=CodeMirror(function(e){v.parentNode.replaceChild(e,v)},{value:t,mode:"spell-checker",backdrop:"markdown",lineWrapping:!0,lineNumbers:!1,dragDrop:!1,theme:"base16-light",scrollbarStyle:"overlay",extraKeys:{Enter:"newlineAndIndentContinueMarkdownList"}}),s=u.$(".CodeMirror"),this._bindCodeMirrorEvents()},A.prototype._getInitialWriterContent=function(){var e=v.innerHTML.trim();return e=u.ltrim(e,"<!--[CDATA["),e=e.replace(/\]\]\-\-\>$/,""),e=e.trim()},A.prototype._highlightCode=function(e,t){if(""===t)return e;try{return hljs.highlight(t,e).value}catch(i){return e}},A.prototype._bindCodeMirrorEvents=function(){var e=this;this.api.code_editor.on("change",function(){e._onWriterChange()}),this.api.code_editor.on("keyup",function(){13==event.keyCode&&e._checkForLists()})},A.prototype._onWriterChange=function(){this._windowResizeHandler(),this._hideSidebar(),this._hideFooter(),this._startAutoSaver()},A.prototype._bindFotterTriggers=function(){var e=this;u.addEventListener(window,"mousemove",this._footerVisibilityHandler),this._bindViewTriggers(),u.addEventListener(u.$(".js-writer-footer .js-insert-h1"),"click",function(){e._toggleHeading("#")}),u.addEventListener(u.$(".js-writer-footer .js-insert-h2"),"click",function(){e._toggleHeading("##")}),u.addEventListener(u.$(".js-writer-footer .js-insert-h3"),"click",function(){e._toggleHeading("###")}),u.addEventListener(u.$(".js-writer-footer .js-insert-h4"),"click",function(){e._toggleHeading("####")}),u.addEventListener(u.$(".js-writer-footer .js-insert-h5"),"click",function(){e._toggleHeading("#####")}),u.addEventListener(u.$(".js-writer-footer .js-insert-h6"),"click",function(){e._toggleHeading("######")}),u.addEventListener(u.$(".js-writer-footer .js-insert-list-normal"),"click",function(){e._toggleList(!0)}),u.addEventListener(u.$(".js-writer-footer .js-insert-list-numbered"),"click",function(){e._toggleList(!1)}),u.addEventListener(u.$(".js-writer-footer .js-insert-table"),"click",function(){e._insertText(e._tableTemplate())}),u.addEventListener(u.$(".js-writer-footer .js-insert-bold"),"click",function(){e._toggleTextStyle("**")}),u.addEventListener(u.$(".js-writer-footer .js-insert-italic"),"click",function(){e._toggleTextStyle("_")}),u.addEventListener(u.$(".js-writer-footer .js-insert-strike"),"click",function(){e._toggleTextStyle("~~")}),u.addEventListener(u.$(".js-writer-footer .js-insert-link"),"click",function(){e._insertWrapText("[","](href)","[text](href)")}),u.addEventListener(window,"resize",this._hideFooter)},A.prototype._bindViewTriggers=function(){for(var e=0;e<E.length;e++)u.addEventListener(E[e],"click",this._changeViewHandler)},A.prototype._changeViewHandler=function(e){e=e||window.event;var i,o=Modules.get("KansoWriter"),n=u.closest(e.target,"button");if(!u.hasClass(n,"active")){var s=!1,a=!1,c=!1,l=document.title.split("|").pop().trim(),d="Review";if(o._saveCurrScrollPos(),n===k?(scrollToWrite=!0,i=w,d="Write",document.getElementsByTagName("html")[0].className="writer-html",o._windowResizeHandler()):n===T?(s=!0,i=y,y.innerHTML=r.render(o.api.code_editor.getValue()),d="Read",document.getElementsByTagName("html")[0].className="reading-html"):(a=!0,i=b,document.getElementsByTagName("html")[0].className="review-html"),null!==o.api.article_id){var p=u.$(".js-writer-form input[name=title]").value.trim();l=""===p?"Untitled":p}t(j,"active",i),t(E,"active",n),s&&window.scrollTo(0,S),a&&window.scrollTo(0,$),c&&o.api.code_editor.scrollTo(null,C),document.title=d+" | "+l}},A.prototype._saveCurrScrollPos=function(){var e=u.$(".js-writer-footer .view-toggles button.active"),t=document.documentElement;e===T&&(S=(window.pageYOffset||t.scrollTop)-(t.clientTop||0)),e===x&&($=(window.pageYOffset||t.scrollTop)-(t.clientTop||0)),e===k&&(C=this.api.code_editor.getScrollInfo().top)},A.prototype._footerVisibilityHandler=function(e){e=e||window.event;var t=window.innerHeight-event.clientY,i=Modules.get("KansoWriter");clearTimeout(c),40>t&&i._showFooter(),c=setTimeout(function(){i._hideFooter()},3e3)},A.prototype._showFooter=function(){clearTimeout(c),u.addClass(L,"active")},A.prototype._hideFooter=function(){clearTimeout(c),u.removeClass(L,"active")},A.prototype._toggleHeading=function(e){var t=this.api.code_editor.getCursor().line,i=this.api.code_editor.getLine(t),o=i.length;if(""!==i&&i[0]&&"#"===i[0]){var n=new RegExp("^"+e+"\\s.+$"),r=new RegExp("^"+e+"$"),s=new RegExp("^"+e+"\\s+$");i=n.test(i)||r.test(i)||s.test(i)?u.ltrim(u.ltrim(i,["#","##","###","####","#####","#####"])):e+" "+u.ltrim(u.ltrim(i,["#","##","###","####","#####","#####"]))}else i=e+" "+u.ltrim(i);this.api.code_editor.replaceRange(i,{line:t,ch:0},{line:t,ch:o}),this._showFooter(),this.api.code_editor.focus()},A.prototype._toggleList=function(e){var t=this.api.code_editor.getCursor().line,i=this.api.code_editor.getLine(t),o=i.length,n="";if(e)n=""===i||!i[0]||"-"!==i[0]&&"+"!==i[0]&&"*"!==i[0]||!i[1]||""!==i[1]&&" "!==i[1]?"- "+u.ltrim(i):u.ltrim(u.ltrim(i,["-","+","*"]));else{var r=new RegExp("^\\d+.\\s+");if(r.test(i))n=u.ltrim(i.replace(/\d+\.\s+/,""));else{var s=1;if(t>0){var a=this.api.code_editor.getLine(t-1);r.test(a)&&(s=parseInt(a[0])+1)}n=s+". "+u.ltrim(i)}}this.api.code_editor.replaceRange(n,{line:t,ch:0},{line:t,ch:o}),this._showFooter(),this.api.code_editor.focus()},A.prototype._toggleTextStyle=function(t){var i=this.api.code_editor.somethingSelected()?this.api.code_editor.getCursor("to"):this.api.code_editor.getCursor(),o=this.api.code_editor.getLine(i.line),n=o.length,r=new RegExp(u.preg_quote(t)+"(.*?)"+u.preg_quote(t)),s=u.preg_match_all(r,o),a="";if(s){for(var c=[],l=0;l<s.length;l++)c.push(s[l].index);var d=e(c,i.ch),p=u.str_split_index(o,d);a=p[0]+u.str_replace(t,"",p[1],2)}else{if(this.api.code_editor.somethingSelected())return a=t+this.api.code_editor.getSelection()+t,this.api.code_editor.replaceSelection(a,"start"),this._showFooter(),void this.api.code_editor.focus();a=t+o+t}this.api.code_editor.replaceRange(a,{line:i.line,ch:0},{line:i.line,ch:n}),this._showFooter(),this.api.code_editor.focus()},A.prototype._insertWrapText=function(e,t,i){var o="";o=this.api.code_editor.somethingSelected()?e+this.api.code_editor.getSelection()+t:i,this.api.code_editor.replaceSelection(o,"start"),this._showFooter(),this.api.code_editor.focus()},A.prototype._insertText=function(e){var t=this.api.code_editor,i=t.getCursor(),o=t.getLine(i.line),n={line:i.line,ch:o.length};t.replaceRange(e,n),this._showFooter(),t.focus()},A.prototype._bindPostMetaTriggers=function(){for(var e=u.$(".js-add-post-meta-btn"),t=u.$All(".js-rmv-post-meta-btn"),i=0;i<t.length;i++)u.addEventListener(t[i],"click",this._removePostMetaHandler);u.addEventListener(e,"click",this._addPostMetaHandler)},A.prototype._removePostMetaHandler=function(e){e=e||window.event,e.preventDefault(),u.removeFromDOM(u.parentUntillClass(this,"js-meta-row"))},A.prototype._addPostMetaHandler=function(e){e=e||window.event,e.preventDefault();var t=u.$(".js-post-meta-container"),i=Modules.get("KansoWriter"),o=document.createElement("DIV");o.className="row roof-xs js-meta-row",o.innerHTML=['<div class="form-field floor-xs">',"<label>Key</label>",'<input type="text" name="post-meta-keys[]" value="" autocomplete="off" size="20">',"</div>","&nbsp;&nbsp;&nbsp;",'<div class="form-field floor-xs">',"<label>Value</label>",'<input type="text" name="post-meta-values[]" value="" autocomplete="off" size="60">',"</div>","&nbsp;&nbsp;&nbsp;",'<button class="btn btn-danger js-rmv-post-meta-btn" type="button">Remove</button>','<div class="row clearfix"></div>'].join(""),t.appendChild(o),u.addEventListener(u.$(".js-rmv-post-meta-btn",o),"click",i._removePostMetaHandler)},A.prototype._bindWindowResize=function(){var e=this;e.api.code_editor.on("viewportChange",e._windowResizeHandler),u.addEventListener(window,"resize",e._windowResizeHandler),e._windowResizeHandler(),e.api.code_editor.execCommand("goDocStart"),e.api.code_editor.focus(),e.api.code_editor.refresh()},A.prototype._windowResizeHandler=function(){w.style.height=window.innerHeight+"px"},A.prototype._bindThumbnailChooser=function(){var e=this,t=u.$(".js-select-img-trigger"),i=u.$(".js-remove-img-trigger"),o=u.$(".js-set-feature-image");u.addEventListener(t,"click",function(t){t=t||window.event,t.preventDefault(),e._showMediaLibrary()}),u.addEventListener(o,"click",function(t){t=t||window.event,t.preventDefault(),e._setThumbnailImage()}),u.addEventListener(i,"click",function(t){t=t||window.event,t.preventDefault(),e._clearThumbnailImage()})},A.prototype._showMediaLibrary=function(){u.addClass(u.$(".js-media-library"),"feature-image")},A.prototype._setThumbnailImage=function(){Modules.get("MediaLibrary")._hideLibrary(),u.$(".js-feature-id").value=u.$("#media_id").value,u.$(".js-feature-img img").src=u.$("#media_url").value,u.addClass(u.$(".js-feature-img"),"active")},A.prototype._clearThumbnailImage=function(){u.$(".js-feature-id").value="",u.removeClass(u.$(".js-feature-img"),"active"),u.$(".js-feature-img img").src=""},A.prototype._bindInputChanges=function(){for(var e=u.$All(".js-review-wrap input, .js-review-wrap textarea, .js-review-wrap select"),t=0;t<e.length;t++)u.addEventListener(e[t],"input",this._inputChangeHandler)},A.prototype._inputChangeHandler=function(){var e=Modules.get("KansoWriter");e._startAutoSaver()},A.prototype._saveArticle=function(e,t){e="undefined"==typeof e?!1:e,t="undefined"==typeof t?!1:t;var i=this;if(this._clearAutoSave(),this.api.is_saving!==!0&&this.api.connected!==!1){this.api.is_saving=!0,t?u.addClass(m,"active"):u.addClass(_,"active");var o=Modules.get("FormValidator",u.$(".js-writer-form"));o.append("ajax_request",this._getAjaxType()),o.append("id",this.api.article_id),o.append("content",this.api.code_editor.getValue()),o.append("access_token",f),t?(this.api.is_published=!0,o.append("status","published")):this.api.is_published===!0?o.append("status","published"):"writer_save_new_article"===this._getAjaxType()&&o.append("status","draft"),h.post(g,o.form(),function(o){var n=u.isJSON(o);n&&n.response?i._onSaved(n.response.id,n.response.slug,e,t):Modules.require("Notifications",{type:"danger",msg:"The server encountered an error while saving the article."}),i.api.is_saving=!1,i._startAutoSaver()},function(){Modules.require("Notifications",{type:"danger",msg:"The server encountered an error while saving the article."}),i.api.is_saving=!1,i._startAutoSaver()})}},A.prototype._getAjaxType=function(){return this.api.new_article===!0?"writer_save_new_article":"writer_save_existing_article"},A.prototype._onSaved=function(e,t,i,o){if(i&&o){var n=location.protocol+"//"+location.host+"/"+t;Modules.require("Notifications",{type:"success",msg:'Your article was successfully published. Click <a href="'+n+'" target="_blank">here</a> to view live.'}),this.api.is_published=!0}else if(i){var n=location.protocol+"//"+location.host+"/"+t;Modules.require("Notifications",{type:"success",msg:'Your article was successfully saved. Click <a href="'+n+'" target="_blank">here</a> to view live.'})}u.removeClass(_,"active"),u.removeClass(m,"active"),this.api.article_id=parseInt(e),this.api.new_article=!1},A.prototype._checkForLists=function(){var e=this.api.code_editor.getCursor().line-1,t=this.api.code_editor.getLine(e),i=new RegExp("^\\d+.\\s+"),o=e+1;""!==t&&(""===t||!t[0]||"-"!==t[0]&&"+"!==t[0]&&"*"!==t[0]||!t[1]||""!==t[1]&&" "!==t[1]?i.test(t)&&(num=parseInt(t[0])+1,toInsert=num+". ",this.api.code_editor.replaceRange(toInsert,{line:o,ch:0})):(toInsert=t[0]+" ",this.api.code_editor.replaceRange(toInsert,{line:o,ch:0})))},A.prototype._startAutoSaver=function(){var e=this;this._clearAutoSave(),d=setTimeout(function(){var t=e.api.code_editor.getValue().trim();""!==t&&p!==t&&(p=t,e._saveArticle(!1))},5e3)},A.prototype._clearAutoSave=function(){clearTimeout(d)},A.prototype._tableTemplate=function(){return["\n| Tables        | Are           | Cool  |\n","| ------------- |:-------------:| -----:|\n","| col 3 is      | right-aligned | $1600 |\n","| col 2 is      | centered      |   $12 |\n","| zebra stripes | are neat      |    $1 |\n"].join("")},A.prototype._bindContextMenu=function(){var e=this.api.code_editor,t=CodeMirror.commands;u.addEventListener(u.$(".js-g-search"),"click",function(){if(e.somethingSelected()){var t=window.open("https://www.google.com.au/search?q="+encodeURIComponent(e.getSelection().trim()),"_blank");t.focus()}}),u.addEventListener(u.$(".js-open-dictionary"),"click",function(){if(e.somethingSelected()){var t=window.open("https://www.google.com.au/search?q=define:"+encodeURIComponent(e.getSelection().trim()),"_blank");t.focus()}}),u.addEventListener(u.$(".js-open-thesaurus"),"click",function(){if(e.somethingSelected()){var t=window.open("https://en.oxforddictionaries.com/thesaurus/"+encodeURIComponent(e.getSelection().trim()),"_blank");t.focus()}}),u.addEventListener(u.$(".js-open-wiki"),"click",function(){if(e.somethingSelected()){var t=window.open("https://en.wikipedia.org/wiki/"+encodeURIComponent(e.getSelection().trim()),"_blank");t.focus()}}),u.addEventListener(u.$(".js-cut"),"click",function(){if(e.somethingSelected()){var t=e.getSelection().trim();clipboard.writeText(t),a=t,e.replaceSelection("","start"),e.focus()}}),u.addEventListener(u.$(".js-copy"),"click",function(){e.somethingSelected()&&(a=e.getSelection().trim(),clipboard.writeText(a))}),u.addEventListener(u.$(".js-paste"),"click",function(){clipboard.readText().then(function(t){e.somethingSelected()?e.replaceSelection(t,"start"):(pos=e.getCursor(),e.setSelection(pos,pos),e.replaceSelection(t,"start")),e.focus()},function(){a&&(e.somethingSelected()?e.replaceSelection(a,"start"):(pos=e.getCursor(),e.setSelection(pos,pos),e.replaceSelection(a,"start"))),e.focus()})}),u.addEventListener(u.$(".js-select-all"),"click",function(){t.selectAll(e)}),u.addEventListener(u.$(".js-select-word"),"click",function(){t.selectNextOccurrence(e)}),u.addEventListener(u.$(".js-titlecase-trigger"),"click",function(){if(e.somethingSelected()){e.getSelection();e.replaceSelection(o(e.getSelection()),"start"),e.focus()}}),u.addEventListener(u.$(".js-uppercase-trigger"),"click",function(){e.somethingSelected()&&(e.replaceSelection(e.getSelection().toUpperCase(),"start"),e.focus())}),u.addEventListener(u.$(".js-lowercase-trigger"),"click",function(){e.somethingSelected()&&(e.replaceSelection(e.getSelection().toLowerCase(),"start"),e.focus())}),u.addEventListener(u.$(".js-sentence-trigger"),"click",function(){e.somethingSelected()&&(e.replaceSelection(i(e.getSelection()),"start"),e.focus())}),u.addEventListener(u.$(".js-suggestions div"),"click",function(t){var i=t.target;u.hasClass(i,"js-suggestion")&&(e.replaceSelection(i.innerHTML.trim(),"start"),e.focus())}),u.addEventListener(w,"contextmenu",this._handleContextMenuVisibility),$Spelling.DefaultDictionary="English (UK)"},A.prototype._handleContextMenuVisibility=function(e){e=e||window.event,e.preventDefault();var t=Modules.get("KansoWriter");t._styleContextMenu(e),u.addClass(H,"active"),u.addClass(document.body,"context-menu-active"),window.addEventListener("click",t._hideContextMenu),t.api.code_editor.somethingSelected()&&t._contextMenuSuggestions()},A.prototype._styleContextMenu=function(e){this.api.code_editor.somethingSelected()?u.addClass(H,"something-selected"):u.removeClass(H,"something-selected"),n()-e.clientY<377?H.style.top=e.clientY-377+"px":H.style.top=e.clientY+"px",n()-e.clientY<440?(u.$(".js-suggestions > div").style.top="initial",u.$(".js-suggestions > div").style.bottom="0",u.$(".js-context-menu-casings > div").style.top="initial",u.$(".js-context-menu-casings > div").style.bottom="0"):(u.$(".js-suggestions > div").style.top="0",u.$(".js-suggestions > div").style.bottom="initial",u.$(".js-context-menu-casings > div").style.top="0",u.$(".js-context-menu-casings > div").style.bottom="initial"),H.style.left=e.clientX+"px"},A.prototype._hideContextMenu=function(){u.removeClass(H,"active"),u.removeClass(document.body,"context-menu-active"),window.removeEventListener("click",Modules.get("KansoWriter")._hideContextMenu)},A.prototype._contextMenuSuggestions=function(){var e=u.$(".js-suggestions ul"),t=this.api.code_editor.getSelection().trim();if(e.innerHTML="",u.count(t.split(" "))>1)return void(e.innerHTML='<li style="opacity:0.3">No Suggestions</li>');if(""!==t){var i=$Spelling.SpellCheckSuggest(t);if(u.empty(i))return void(e.innerHTML='<li style="opacity:0.3">No Suggestions</li>');u.isset(i[1])||(i=i[0]);for(var o=0;o<i.length;o++)e.innerHTML+='<li class="js-suggestion">'+i[o]+"</li>"}},A.prototype._initOfflineJs=function(){function e(){u.addClass(o,"active"),Offline.on("up",t),i.api.connected=!1,i._clearAutoSave()}function t(){u.removeClass(o,"active"),Offline.off("up",t),i.api.connected=!0,i._startAutoSaver()}var i=this,o=u.$(".js-offline-overlay");Offline.options={checkOnLoad:!1,interceptRequests:!1,checks:{xhr:{url:window.location.href.replace(/admin(.+)/,"kanso/cms/admin/assets/js/check-connection.js")}},requests:!1,game:!1},Offline.on("down",e)},Modules.singleton("KansoWriter",A).get("KansoWriter")}();