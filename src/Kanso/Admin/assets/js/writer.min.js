!function(){var a,b,c,d,e,f,g,h,i,j,k,l=document.documentElement,m=(window.location.href.replace(/admin(.+)/,"admin/"),$("#writer")),n=$(".writer"),o=$(".writer-footer .js-save-post"),p=$(".reviewer .js-article-form button.submit"),q=($(".reviewer .js-article-form"),$All(".reviewer .js-article-form input, .reviewer .js-article-form textarea, .reviewer .js-article-form select")),r=!0,s=0,t=[],u=$(".js-thumbnail"),v=$(".js-hero-drop form"),w=$(".js-hero-drop .upload-bar .progress"),x=!0,y=0,z=$(".writer"),A=$(".reader"),B=$(".reviewer"),C=0,D=0,E=0,F=$(".writer-footer"),G=$(".writer-footer .js-raw"),H=$(".writer-footer .js-html"),I=$(".writer-footer .js-pre-publish"),J=function(){this.version="1.0.0",this.author="Joe Howard",this.copyright="Kanso 2015",this.writer=null,this.saveTimer=null,this.hasSaved=!1,this.markdown=window.markdownit({html:!0,xhtmlOut:!1,breaks:!0,langPrefix:"",linkify:!1,highlight:this.highlightCode}),this.articleID=null,this.ajaxType="writer_save_new_article",this.initialize(),this.initCodeMirror(),this.initWindowResize(),this.initHeroDZ(),this.initInputChanges(),this.initFooter()};J.prototype={},J.prototype.initialize=function(){var a=this,b=m.dataset.id;b&&""!==b&&(this.articleID=parseInt(b),this.ajaxType="writer_save_existing_article"),o.addEventListener("click",function(b){a.saveArticle(b,a)}),p.addEventListener("click",function(b){a.publishArticle(b,a)}),this.initToggleHeader()},J.prototype.highlightCode=function(a,b){if(""===b)return a;try{return hljs.highlight(b,a).value}catch(c){return a}},J.prototype.initToggleHeader=function(){var a=$(".header"),b=$(".js-show-header"),c=$(".js-hide-header");b.addEventListener("click",function(){event.preventDefault(),removeClass(a,"active")}),c.addEventListener("click",function(){event.preventDefault(),addClass(a,"active")}),this.initHeaderMouseListener()},J.prototype.initHeaderMouseListener=function(){var a=$(".js-show-header");window.addEventListener("mousemove",function(){var b=event.clientY;40>b&&(clearTimeout(k),a.style.opacity="1",k=setTimeout(function(){a.style.opacity="0"},8e4))})},J.prototype.initFooter=function(){var a=this;window.addEventListener("mousemove",a.footerMouseListener),this.initToggleButtons(),$(".writer-footer .js-insert-h1").addEventListener("click",function(){a.toggleHeading("#",a)}),$(".writer-footer .js-insert-h2").addEventListener("click",function(){a.toggleHeading("##",a)}),$(".writer-footer .js-insert-h3").addEventListener("click",function(){a.toggleHeading("###",a)}),$(".writer-footer .js-insert-h4").addEventListener("click",function(){a.toggleHeading("####",a)}),$(".writer-footer .js-insert-h5").addEventListener("click",function(){a.toggleHeading("#####",a)}),$(".writer-footer .js-insert-h6").addEventListener("click",function(){a.toggleHeading("######",a)}),$(".writer-footer .js-insert-list-normal").addEventListener("click",function(){a.toggleList(a,!0)}),$(".writer-footer .js-insert-list-numbered").addEventListener("click",function(){a.toggleList(a,!1)}),$(".writer-footer .js-insert-bold").addEventListener("click",function(){a.toggleTextStyle("**",a)}),$(".writer-footer .js-insert-italic").addEventListener("click",function(){a.toggleTextStyle("_",a)}),$(".writer-footer .js-insert-strike").addEventListener("click",function(){a.toggleTextStyle("~~",a)}),$(".writer-footer .js-insert-link").addEventListener("click",function(){a.insertWrapText("[","](href)","[text](href)",a)}),$(".writer-footer .js-insert-image").addEventListener("click",function(){a.insertWrapText("![","](src)","![altText](src)",a)})},J.prototype.initToggleButtons=function(){var a=this;j=[G,H,I],h=[z,A,B];for(var b=0;b<j.length;b++)j[b].addEventListener("click",function(b){a.toggleView(b,a)})},J.prototype.toggleView=function(a,b){var c,d=closest(a.target,"button"),e="";if(!hasClass(d,"active")){var f=!1,g=!1,i=!1,k=$(".writer-footer .view-toggles button.active");k===H&&(C=(window.pageYOffset||l.scrollTop)-(l.clientTop||0)),k===I&&(E=(window.pageYOffset||l.scrollTop)-(l.clientTop||0)),k===G&&(D=b.writer.getScrollInfo().top);var m="Review",n=document.title.split("|").pop().trim();if(d===G?(scrollToWrite=!0,c=z,e="writing markdown",m="Write",document.getElementsByTagName("html")[0].className="writer-html",b.windowResize()):d===H?(f=!0,c=A,e="writing HTML",A.innerHTML=b.markdown.render(b.writer.getValue()),m="Read",document.getElementsByTagName("html")[0].className="reading"):(g=!0,e="writing review",c=B,document.getElementsByTagName("html")[0].removeAttribute("class")),null!==b.articleID){var o=$(".js-article-form input[name=title]").value.trim();n=""===o?"Untitled":o}removeClassNodeList(h,"active",c),removeClassNodeList(j,"active",d),document.body.className=e,f&&window.scrollTo(0,C),g&&window.scrollTo(0,E),i&&b.writer.scrollTo(null,D),document.title=m+" | "+n}},J.prototype.showFooter=function(){clearTimeout(i),addClass(F,"active"),i=setTimeout(function(){removeClass(F,"active")},8e4)},J.prototype.footerMouseListener=function(){var a=window.innerHeight-event.clientY;40>a&&(clearTimeout(i),addClass(F,"active"),i=setTimeout(function(){removeClass(F,"active")},8e4))},J.prototype.toggleHeading=function(a,b){var c=b.writer.getCursor().line,d=b.writer.getLine(c),e=d.length;if(""!==d&&d[0]&&"#"===d[0]){var f=new RegExp("^"+a+"\\s.+$");d=f.test(d)?ltrim(ltrim(d,["#","##","###","####","#####","#####"])):a+" "+ltrim(ltrim(d,["#","##","###","####","#####","#####"]))}else d=a+" "+ltrim(d);b.writer.replaceRange(d,{line:c,ch:0},{line:c,ch:e}),b.showFooter(),b.writer.focus()},J.prototype.toggleList=function(a,b){var c=a.writer.getCursor().line,d=a.writer.getLine(c),e=d.length,f="";if(b)f=""===d||!d[0]||"-"!==d[0]&&"+"!==d[0]&&"*"!==d[0]||!d[1]||""!==d[1]&&" "!==d[1]?"- "+ltrim(d):ltrim(ltrim(d,["-","+","*"]));else{var g=new RegExp("^\\d+.\\s+");if(g.test(d))f=ltrim(d.replace(/\d+\.\s+/,""));else{var h=1;if(c>0){var i=a.writer.getLine(c-1);g.test(i)&&(h=parseInt(i[0])+1)}f=h+". "+ltrim(d)}}a.writer.replaceRange(f,{line:c,ch:0},{line:c,ch:e}),a.showFooter(),a.writer.focus()},J.prototype.toggleTextStyle=function(a,b){var c=b.writer.somethingSelected()?b.writer.getCursor("to"):b.writer.getCursor(),d=b.writer.getLine(c.line),e=d.length,f=new RegExp(preg_quote(a)+"(.*?)"+preg_quote(a)),g=preg_match_all(f,d),h="";if(g){for(var i=[],j=0;j<g.length;j++)i.push(g[j].index);var k=closest_number(i,c.ch),l=str_split_index(d,k);h=l[0]+str_replace(a,"",l[1],2)}else{if(b.writer.somethingSelected())return h=a+b.writer.getSelection()+a,b.writer.replaceSelection(h,"start"),b.showFooter(),void b.writer.focus();h=a+d+a}b.writer.replaceRange(h,{line:c.line,ch:0},{line:c.line,ch:e}),b.showFooter(),b.writer.focus()},J.prototype.insertWrapText=function(a,b,c,d){var e="";e=d.writer.somethingSelected()?a+d.writer.getSelection()+b:c,d.writer.replaceSelection(e,"start"),d.showFooter(),d.writer.focus()},J.prototype.initCodeMirror=function(){var b=this;this.writer=CodeMirror.fromTextArea(m,{mode:"markdown",lineWrapping:!0,lineNumbers:!1,dragDrop:!1,theme:"base16-light",scrollbarStyle:"overlay",extraKeys:{Enter:"newlineAndIndentContinueMarkdownList"}}),a=$(".CodeMirror"),this.writer.on("change",function(){b.updateCodeMirrorLayout(b)}),this.initWriterDZ(this),this.initWriterEvents()},J.prototype.initWindowResize=function(){var a=this;a.writer.on("viewportChange",a.windowResize),window.addEventListener("resize",a.windowResize),a.windowResize(),a.writer.execCommand("goDocStart"),a.writer.focus(),a.writer.refresh()},J.prototype.windowResize=function(){n.style.height=window.innerHeight+"px"},J.prototype.updateCodeMirrorLayout=function(a){a.windowResize(),clearTimeout(a.saveTimer),a.saveTimer=setTimeout(function(){addClass($(".js-save-post"),"active")},1500),clearTimeout(k),$(".js-show-header").style.opacity="0",clearTimeout(i),removeClass(F,"active")},J.prototype.initWriterDZ=function(c){var d={url:GLOBAL_AJAX_URL,maxFilesize:5,parallelUploads:1,uploadMultiple:!1,clickable:!1,createImageThumbnails:!1,maxFiles:null,acceptedFiles:".jpg,.png",autoProcessQueue:!1,dictInvalidFileType:"Error! Unsupported file or files. You can't upload files of that type.",dictFileTooBig:"Error! File or files are too lare. Max upload size is 5mb per file.",dictResponseError:"There was an error processing the request. Try again in a few moments.",dictMaxFilesExceeded:"Error! Too many uploads at once. Upload limit is 1 file per drop."};b=new Dropzone(a,d),c.initWriteDZEvents()},J.prototype.initWriteDZEvents=function(){var e=this;b.on("drop",function(b){removeClass(a,"dz-started");var c=$(".dz-preview",a),d=$All(".dz-preview",a);if(nodeExists(c))for(var e=0;e<d.length;e++)removeFromDOM(d[e])}),b.on("sending",function(a,b,c){c.append("ajaxRequest","writer_image_upload"),c.append("public_key",GLOBAL_PUBLIC_KEY)}),b.on("uploadprogress",function(a,b){GLOBAL_PROGRESS.style.width=b+"%"}),b.on("error",function(a,b,c){pushNotification("alert",b)}),b.on("addedfile",function(a){s++,s>1?(r=!1,clearTimeout(c),d=setTimeout(writerDZ_callback_showError,300)):1===s&&(c=setTimeout(e.writerDZ_callback_processQueu,300))}),b.on("success",function(a,b){if("object"!=typeof b&&b===isJSON(b),"object"==typeof b&&b&&b.response&&"processed"===b.response){var c=b.details,d="![Alt Text]("+encodeURI(c)+' "Image Title")';return e.writer.replaceSelection(d,"start"),pushNotification("success","Your file was successfully uploaded!"),clearTimeout(e.savePostTimer),void addClass($(".js-save-post"),"active")}pushNotification("error","There was an error processing the request. Try again in a few moments.")}),b.on("complete",function(a){r=!0,s=0,GLOBAL_PROGRESS.style.width="0%",t=[]}),b.on("dragenter",function(a){if(!(t.length>0)){var b='![Alt Text](https://example.com/image.jpg "Image Title")',c=e.writer.getCursor();c={line:c.line,ch:c.line},e.writer.somethingSelected()&&e.writer.setSelection(c),t.push(c),e.writer.replaceSelection(b,"around")}}),b.on("dragleave",function(a){t.length>0&&(e.writer.replaceSelection("","start"),t=[])})},J.prototype.writerDZ_callback_showError=function(){clearTimeout(d),pushNotification("error","Error! Too many uploads at once. Upload limit is 1 file per drop."),r=!0,s=0,t=[]},J.prototype.writerDZ_callback_processQueu=function(){clearTimeout(c),r===!0&&b.processQueue(),r=!0,s=0,t=[]},J.prototype.initHeroDZ=function(){var a={url:GLOBAL_AJAX_URL,maxFilesize:5,parallelUploads:1,uploadMultiple:!1,clickable:!0,createImageThumbnails:!0,maxFiles:null,acceptedFiles:".jpg,.png",autoProcessQueue:!1,maxThumbnailFilesize:5,thumbnailWidth:800,thumbnailHeight:400,resize:this.resizeHeroDropImage,dictInvalidFileType:"Error! Unsupported file or files. You can't upload files of that type.",dictFileTooBig:"Error! File or files are too lare. Max upload size is 5mb per file.",dictResponseError:"There was an error processing the request. Try again in a few moments.",dictMaxFilesExceeded:"Error! Too many uploads at once. Upload limit is 1 file per drop."};e=new Dropzone(v,a),this.initHeroDZEvents()},J.prototype.resizeHeroDropImage=function(a){var b=a.width,c=a.height,d=ImageResizer(b,c,!0),e=d.crop(800,400);return{srcX:e.source_x,srcY:e.source_y,srcWidth:e.source_w,srcHeight:e.source_h,trgX:e.dest_x,trgY:e.dest_y,trgWidth:800,trgHeight:400}},J.prototype.initHeroDZEvents=function(){var a=e,b=this;a.on("uploadprogress",function(a,b){w.style.width=b+"%"}),a.on("sending",function(a,b,c){c.append("ajaxRequest","writer_image_upload"),c.append("public_key",GLOBAL_PUBLIC_KEY)}),a.on("drop",function(a){b.HeroDZ_cleanUp()}),a.on("error",function(a,c,d){b.HeroDZ_cleanUp(),pushNotification("alert",c)}),a.on("addedfile",function(a){y++,y>1?(b.HeroDZ_cleanUp(),x=!1,clearTimeout(f),g=setTimeout(b.HeroDZ_showError,300)):1===y&&(f=setTimeout(b.HeroDZ_processQueu,300))}),a.on("success",function(a,c){return"object"!=typeof c&&c===isJSON(c),"object"==typeof c&&c&&c.response&&"processed"===c.response?(pushNotification("success","Your file was successfully uploaded!"),b.HeroDZ_updateForm(c.details),clearTimeout(b.savePostTimer),void addClass($(".js-save-post"),"active")):void pushNotification("error","There was an error processing the request. Try again in a few moments.")}),a.on("complete",function(a){x=!0,y=0,w.style.width="0%"})},J.prototype.HeroDZ_showError=function(){clearTimeout(g),pushNotification("error","Error! Too many uploads at once. Upload limit is 1 file per drop."),x=!0,y=0},J.prototype.HeroDZ_processQueu=function(){clearTimeout(f),x===!0&&e.processQueue(),x=!0,y=0},J.prototype.HeroDZ_cleanUp=function(){removeClass(v,"dz-started");var a=$(".js-hero-drop .dz-preview"),b=$All(".js-hero-drop .dz-preview");if(nodeExists(a))for(var c=0;c<b.length;c++)removeFromDOM(b[c])},J.prototype.HeroDZ_updateForm=function(a){clearTimeout(self.savePostTimer),a=a.substring(a.lastIndexOf("/")+1),u.value=a,addClass($(".js-save-post"),"active")},J.prototype.initInputChanges=function(){for(var a=this,b=$All(".reviewer .input-default"),c=0;c<b.length;c++)b[c].addEventListener("input",function(){clearTimeout(a.saveTimer),a.saveTimer=setTimeout(function(){addClass($(".js-save-post"),"active")},1500)})},J.prototype.saveArticle=function(a,b){if(a.preventDefault(),clearTimeout(b.saveTimer),!hasClass(p,"active")){var c=formValidator(q);return c.formAppend("ajaxRequest",b.ajaxType),c.formAppend("id",b.articleID),c.formAppend("content",b.writer.getValue()),GLOBAL_AJAX_ENABLED?void Ajax.post(GLOBAL_AJAX_URL,c.getForm(),function(a){var c=isJSON(a);return c&&c.details?(b.articleID=c.details.id,b.ajaxType="writer_save_existing_article",pushNotification("success","Your article was successfully saved!"),clearTimeout(b.saveTimer),void removeClass($(".js-save-post"),"active")):void pushNotification("error","The server encoutered an error while saving the article.")},function(a){pushNotification("error","The server encoutered an error while saving the article.")}):void pushNotification("error","The server encoutered an error while saving the article.")}},J.prototype.publishArticle=function(a,b){if(a.preventDefault(),clearTimeout(b.saveTimer),!hasClass(p,"active")){var c=formValidator(q);return c.formAppend("ajaxRequest","writer_publish_article"),c.formAppend("id",b.articleID),c.formAppend("content",b.writer.getValue()),GLOBAL_AJAX_ENABLED?void Ajax.post(GLOBAL_AJAX_URL,c.getForm(),function(a){var c=isJSON(a);if(c&&c.details){b.articleID=c.details.id,b.ajaxType="writer_save_existing_article";var d=GLOBAL_AJAX_URL.replace("/admin","")+c.details.slug;return pushNotification("success",'Your article was successfully published. Click <a href="'+d+'" target="_blank">here</a> to view live.'),clearTimeout(b.saveTimer),void removeClass($(".js-save-post"),"active")}return void pushNotification("error","The server encoutered an error while publishing the article.")},function(a){pushNotification("error","The server encoutered an error while publishing the article.")}):void pushNotification("error","The server encoutered an error while publishing the article.")}},J.prototype.initWriterEvents=function(){var a=this;this.writer.on("keyup",function(){13==event.keyCode&&a.checkForLists(a)})},J.prototype.checkForLists=function(a){var b=a.writer.getCursor().line-1,c=a.writer.getLine(b),d=new RegExp("^\\d+.\\s+"),e=b+1;""!==c&&(""===c||!c[0]||"-"!==c[0]&&"+"!==c[0]&&"*"!==c[0]||!c[1]||""!==c[1]&&" "!==c[1]?d.test(c)&&(num=parseInt(c[0])+1,toInsert=num+". ",a.writer.replaceRange(toInsert,{line:e,ch:0})):(toInsert=c[0]+" ",a.writer.replaceRange(toInsert,{line:e,ch:0})))};new J}();